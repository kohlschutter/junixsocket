<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/crosscomp.md at 2022-06-06
 | Rendered using Apache Maven Fluido Skin 1.11.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>junixsocket &#x2013; Cross-compiling junixsocket</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.11.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script src="./js/apache-maven-fluido-1.11.0.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <a href="https://github.com/kohlschutter/junixsocket">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"
        alt="Fork me on GitHub">
    </a>
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><div id="bannerLeft"><h1>junixsocket — Unix Domain Sockets for Java</h1>
</div>
</div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2022-06-06<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 2.5.0</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Overview</li>
    <li><a href="index.html" title="Welcome"><span class="none"></span>Welcome</a></li>
    <li><a href="changelog.html" title="New & Noteworthy"><span class="none"></span>New & Noteworthy</a></li>
    <li><a href="quickstart.html" title="Quick Start"><span class="none"></span>Quick Start</a></li>
    <li><a href="compatibility.html" title="Compatibility"><span class="none"></span>Compatibility</a></li>
    <li><a href="dependency.html" title="Add junixsocket to your project"><span class="none"></span>Add junixsocket to your project</a></li>
    <li><a href="faq.html" title="FAQ"><span class="none"></span>FAQ</a></li>
   <li class="nav-header">Demo Code</li>
    <li><a href="demo.html" title="Command line demos"><span class="none"></span>Command line demos</a></li>
    <li><a href="junixsocket-demo/xref/index.html" title="Source reference"><span class="none"></span>Source reference</a></li>
    <li><a href="filedescriptors.html" title="Sending file descriptors"><span class="none"></span>Sending file descriptors</a></li>
    <li><a href="peercreds.html" title="Peer credentials"><span class="none"></span>Peer credentials</a></li>
   <li class="nav-header">For Developers</li>
    <li><a href="development.html" title="Developing junixsocket"><span class="none"></span>Developing junixsocket</a></li>
    <li><a href="unixsockets.html" title="Unix Sockets Reference"><span class="none"></span>Unix Sockets Reference</a></li>
    <li><a href="customarch.html" title="Custom architectures"><span class="none"></span>Custom architectures</a></li>
    <li class="active"><a><span class="none"></span>Cross-Compiling with crossclang</a></li>
    <li><a href="eclipse.html" title="Developing with Eclipse"><span class="none"></span>Developing with Eclipse</a></li>
    <li><a href="release.html" title="Release Instructions"><span class="none"></span>Release Instructions</a></li>
   <li class="nav-header">Reference</li>
    <li><a href="junixsocket-codecoverage/jacoco-aggregate/index.html" title="Code Coverage"><span class="none"></span>Code Coverage</a></li>
   <li class="nav-header">Modules</li>
    <li><a href="junixsocket-common/index.html" title="junixsocket-common"><span class="none"></span>junixsocket-common</a></li>
    <li><a href="junixsocket-tipc/index.html" title="junixsocket-tipc"><span class="none"></span>junixsocket-tipc</a></li>
    <li><a href="junixsocket-server/index.html" title="junixsocket-server"><span class="none"></span>junixsocket-server</a></li>
    <li><a href="junixsocket-rmi/index.html" title="junixsocket-rmi"><span class="none"></span>junixsocket-rmi</a></li>
    <li><a href="junixsocket-mysql/index.html" title="junixsocket-mysql"><span class="none"></span>junixsocket-mysql</a></li>
    <li><a href="junixsocket-core/index.html" title="junixsocket-core"><span class="none"></span>junixsocket-core</a></li>
    <li><a href="junixsocket-demo/index.html" title="junixsocket-demo"><span class="none"></span>junixsocket-demo</a></li>
    <li><a href="junixsocket-selftest/index.html" title="junixsocket-selftest"><span class="none"></span>junixsocket-selftest</a></li>
    <li><a href="junixsocket-dist/index.html" title="junixsocket-dist"><span class="none"></span>junixsocket-dist</a></li>
    <li><a href="junixsocket-codecoverage/index.html" title="junixsocket-codecoverage"><span class="none"></span>junixsocket-codecoverage</a></li>
    <li><a href="junixsocket-native/index.html" title="junixsocket-native"><span class="none"></span>junixsocket-native</a></li>
    <li><a href="junixsocket-native-cross/index.html" title="junixsocket-native-cross"><span class="none"></span>junixsocket-native-cross</a></li>
    <li><a href="junixsocket-native-custom/index.html" title="junixsocket-native-custom"><span class="none"></span>junixsocket-native-custom</a></li>
    <li><a href="junixsocket-native-common/index.html" title="junixsocket-native-common"><span class="none"></span>junixsocket-native-common</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<h1>Cross-compiling junixsocket</h1>
<p>Thanks to clang-llvm and junixsocket's custom &#x201c;crossclang&#x201d; script, we can now compile the native
JNI code for both macOS and Linux, on <i>either</i> platform.</p><section>
<h2><a name="Prerequisites"></a>Prerequisites</h2>
<p>In order to cross-compile, our development machine (the one where we do the compilation), needs
to have clang and llvm.</p>
<p>On Mac, the Xcode version of clang is not sufficient. You have to install llvm from Homebrew:</p>

<div class="source"><pre class="prettyprint"><code>brew install llvm
</code></pre></div>
<p>In order to compile for RISC-V, you need LLVM 9. Currently, it won't compile on newer versions, so install that one, too:</p>

<div class="source"><pre class="prettyprint"><code>brew install llvm@9
</code></pre></div></section><section>
<h2><a name="Setting_up_the_target_SDKs"></a>Setting up the target SDKs</h2>
<p>First, we need to setup the SDK of all supported target platforms, so we can build our code one
a single machine. SDKs are not included with junixsocket. You need to either acquire them somehow
in prepared form or create an SDK from a machine running your target platform.</p>
<p>In our terminology, an SDK consists of the headers and libraries that can be compiled against, and
some instructions for the compiler to know how to add these together.</p>
<p>To simplify this process, junixsocket provides the a script that can be used to automatically generate
an SDK from a target machine:</p>

<div class="source"><pre class="prettyprint"><code>junixsocket-native/crossclang/bin/prepare-target-sdk
</code></pre></div>
<p>Run this command on all target platforms, including your development machine.</p>
<p>Each target machine creates an SDK directory under <code>junixsocket-native/crosslang/target-sdks/</code>.</p>
<p>Copy all target SDKs to the same directory on your development machine, so you can use them.
To avoid duplication, it is encouraged that you store the target SDKs in a shared directory named
<code>/opt/crossclang/target-sdks</code> (or <code>$HOME/.crossclang/target-sdks</code>).</p>
<p>By default, the name of the SDK is a <i>triple</i> identifier that is compatible with clang, etc.
For example:</p>
<ul>

<li>x86_64-apple-darwin18.2.0 (corresponding to macOS Mojave 10.14.2)</li>
<li>x86_64-pc-linux-gnu</li>
</ul>
<p>The contents of the SDK directory are:</p>
<ul>

<li>The directory structure for the headers (e.g., <code>usr/include</code>)</li>
<li>The directory structure for the libraries (e.g., <code>usr/lib</code>, <code>lib</code>, etc.) &#x2014; this may be optional.</li>
<li>A configuration file (<code>target.conf</code>) that contains information about how these headers and libraries are to be used, etc.</li>
<li>A header file (<code>target.h</code>) that gets included by default when building for this target</li>
</ul>
<p><code>prepare-target-sdk</code> takes care of building these folders, but if it doesn't work out on your target
machine, you can create one yourself or modify an existing one to your liking.</p>
<p>If you want to create specific SDKs that use the same compiler triple but otherwise are different
enough to warrant being separate, simply rename the directory to a name of your liking. You can
also make use symbolic links.</p></section><section>
<h2><a name="Cross-compiling_junixsocket_for_supported_platforms."></a>Cross-compiling junixsocket for supported platforms.</h2>
<p>By default, junixsocket's Maven environment cross-compiles for both x86_64 Linux and macOS.</p>
<p>All you need to do is to specify a flag when building the <i>junixsocket</i> parent project:</p>

<div class="source"><pre class="prettyprint"><code>cd junixsocket
mvn clean install -Dcross=true
</code></pre></div>
<p>Cross-compilation is also enabled when building with the &#x201c;release profile&#x201d; (<code>-Prelease</code>), unlesss
it's explicitly disabled with <code>-Dcross=false</code>.</p>
<p>If you want to extend support beyond these platforms, check the <code>pom.xml</code> files in <i>junixsocket</i>,
<i>junixsocket-native</i>, junixsocket-native-cross, and junixsocket-native-common.</p>
<blockquote>

<p><b>NOTE:</b> On Linux, the junixsocket library is not always linked against glibc.
Some distributions use alternative libc implementations, such as musl-libc (on Alpine Linux, for
example). In order to support these environments, the native library loader tries to load the
junixsocket version for glibc first, and if that doesn't work, it falls back to the &#x201c;.nodeps.so&#x201d;
version, which does not have glibc linked.</p>
</blockquote></section><section>
<h2><a name="Using_crossclang_from_the_command-line"></a>Using crossclang from the command-line</h2>
<p><i>crossclang</i> (in <code>junixsocket-native/crossclang/bin/clang</code>) is just a small wrapper around <code>clang</code> to
simplify configuring the compiler (and linker) to a specific target environment.</p>
<p>It forwards arguments to the actual <code>clang</code> binary, and additionally configures it depending on the
value specified with the <code>-target</code> argument. If no target triple (or <code>current</code>) is specified, the
crossclang infers the triple of the current architecture, and looks for the corresponding SDK in
<code>target-sdks</code>. If <code>-target default</code> is specified, the call is forwarded to the upstream clang compiler.
If you specify a target that starts with a slash (<code>/</code>), the target is considered an absolute path
to a specific target SDK.</p>
<p>crossclang automatically configures clang to use the correct sysroot, system include paths,
system library paths, system framework paths and the proper linker suitable for the platform (e.g.,
ld64.lld for Mac and ld.lld for Unix).</p></section><section>
<h2><a name="Testing_crossclang"></a>Testing crossclang</h2>
<p>Let's use a very simple example program, <code>test.c</code>:</p>

<div class="source"><pre class="prettyprint"><code>#include &lt;stdio.h&gt;

int main(int argc, char *argv[]) {
    printf(&quot;Hello world, crossclang style!\n&quot;);
    return 0;
}
</code></pre></div>
<p>With crossclang, cross-compilation is as easy as this:</p>

<div class="source"><pre class="prettyprint"><code># Compile (and link) for x86_64 Linux
crossclang/bin/clang -o test-linux64 test.c -target x86_64-pc-linux-gnu


# Compile (and link) for x86_64 macOS
crossclang/bin/clang -o test-mac64 test.c -target x86_64-apple-darwin18.2.0


# Compile (and link) for ARMv5 Linux
crossclang/bin/clang -o test-linuxarmv5 test.c -target armv5tel-unknown-linux-gnueabi


# Compile (and link) for the current architecture, no matter what it is
crossclang/bin/clang -o test test.c -target current


# Compile (and link) using the default clang for the current architecture
crossclang/bin/clang -o test test.c -target default
</code></pre></div>
<p>For junixsocket, specifically, you can speed-up your porting development by directly compiling
the JNI code as follows:</p>

<div class="source"><pre class="prettyprint"><code>cd junixsocket/junixsocket-native
crossclang/bin/clang src/main/c/org_newsclub_net_unix_NativeUnixSocket.c \
    -target (target-platform) \
    -I /(path-to-java-jdk)/include/ \
    -I /(path-to-java-jdk)/include/(platform-specific)/ \
    -shared (additional flags) \
    -olibjunixtest.so
</code></pre></div></section><section>
<h2><a name="Limitations"></a>Limitations</h2>
<p>Right now, crossclang only supports C and C++. However, adding support other languages should
be relatively straightforward.</p></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>&#169;      2009&#x2013;2022
<a href="https://www.kohlschutter.com/">Kohlschütter Search Intelligence</a>
</p>
        </div>
      </div>
    </footer>
<script>
	if(anchors) {
	  anchors.add();
	}
</script>
  </body>
</html>